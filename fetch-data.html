<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFBD Data Fetcher</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>CFBD Data Fetcher</h1>
    <p>This will fetch 2021-2024 college football data from the CFBD API.</p>
    
    <button onclick="fetchData()">Fetch Data</button>
    <button onclick="clearOutput()">Clear Output</button>
    
    <div id="output"></div>

    <script>
        const CONFIG = {
            apiKey: 'AYkI+Yu/PHFp5lbWxTjrAjN0q4DFidrdJgSoiGvPXve807qSdw0BJ6c08Vf0kFcN',
            apiBaseUrl: 'https://api.collegefootballdata.com',
            rateLimitDelay: 1000,
            seasons: [2024, 2023, 2022, 2021],
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            output.appendChild(div);
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function fetchTeamsFromCFBD() {
            try {
                const headers = { 
                    'accept': 'application/json', 
                    'Authorization': `Bearer ${CONFIG.apiKey}` 
                };
                const url = `${CONFIG.apiBaseUrl}/teams`;
                log(`Fetching teams from: ${url}`);
                
                const res = await fetch(url, { headers });
                
                if (!res.ok) {
                    throw new Error(`Teams API request failed: ${res.status} ${res.statusText}`);
                }
                
                const teams = await res.json();
                log(`‚úÖ Fetched ${teams.length} teams from CFBD API`, 'success');
                return teams;
            } catch (error) {
                log(`‚ùå Error fetching teams: ${error.message}`, 'error');
                return [];
            }
        }

        async function fetchFromCFBD(season = 2023) {
            try {
                const headers = { 
                    'accept': 'application/json', 
                    'Authorization': `Bearer ${CONFIG.apiKey}` 
                };
                const url = `${CONFIG.apiBaseUrl}/games?year=${season}&seasonType=regular`;
                log(`Fetching games for ${season} from: ${url}`);
                
                const res = await fetch(url, { headers });
                
                if (!res.ok) {
                    throw new Error(`API request failed: ${res.status} ${res.statusText}`);
                }
                
                const data = await res.json();
                log(`‚úÖ Fetched ${data.length} raw games for ${season}`, 'success');
                return data;
            } catch (error) {
                log(`‚ùå Error fetching games for ${season}: ${error.message}`, 'error');
                return [];
            }
        }

        function normalizeCFBDGame(row, teams) {
            if (!row.homeTeam || !row.awayTeam || row.homePoints == null || row.awayPoints == null || !row.completed) return null;
            
            const teamAName = row.homeTeam;
            const teamBName = row.awayTeam;
            const teamA = resolveTeam(teamAName, row.homePoints, teams);
            const teamB = resolveTeam(teamBName, row.awayPoints, teams);
            const winner = row.homePoints > row.awayPoints ? teamA.abbr : teamB.abbr;
            
            return {
                id: `${row.season}-${row.week}-${teamA.abbr}-${teamB.abbr}`,
                season: row.season,
                date: row.startDate ? row.startDate.slice(0,10) : '',
                teamA, teamB, winner
            };
        }

        function resolveTeam(name, score, teams) {
            const apiTeam = teams.find(t => t.name === name || t.abbreviation === name);
            
            return {
                name: apiTeam ? apiTeam.name : name,
                abbr: apiTeam ? apiTeam.abbreviation : name.slice(0, 3).toUpperCase(),
                logo: `icons/${name.toLowerCase().replace(/\s+/g, '-')}.png`,
                score
            };
        }

        async function fetchAllSeasons(teams) {
            const allGames = [];
            
            for (const season of CONFIG.seasons) {
                log(`\nüìÖ Fetching games for season ${season}...`);
                const rawGames = await fetchFromCFBD(season);
                const normalizedGames = rawGames.map(game => normalizeCFBDGame(game, teams)).filter(Boolean);
                allGames.push(...normalizedGames);
                
                log(`  ‚Üí Found ${normalizedGames.length} valid games for ${season}`);
                
                if (season !== CONFIG.seasons[CONFIG.seasons.length - 1]) {
                    log(`‚è≥ Waiting ${CONFIG.rateLimitDelay}ms before next request...`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.rateLimitDelay));
                }
            }
            
            return allGames;
        }

        async function fetchData() {
            clearOutput();
            log('üöÄ Starting data fetch...');
            
            try {
                const teams = await fetchTeamsFromCFBD();
                const games = await fetchAllSeasons(teams);
                
                log(`\nüìä Total games fetched: ${games.length}`);
                
                if (games.length > 0) {
                    const gamesBySeason = games.reduce((acc, game) => {
                        acc[game.season] = (acc[game.season] || 0) + 1;
                        return acc;
                    }, {});
                    
                    log('Games by season:');
                    Object.entries(gamesBySeason).forEach(([season, count]) => {
                        log(`  ${season}: ${count} games`);
                    });
                    
                    const teamsMapping = {};
                    teams.forEach(team => {
                        teamsMapping[team.name] = {
                            abbr: team.abbreviation,
                            logo: `icons/${team.name.toLowerCase().replace(/\s+/g, '-')}.png`
                        };
                    });
                    
                    log('\nüìã === COPY THIS TO data/teams.json ===');
                    const teamsJson = JSON.stringify(teamsMapping, null, 2);
                    log(teamsJson);
                    
                    log('\nüìã === COPY THIS TO data/games.json ===');
                    const gamesJson = JSON.stringify(games, null, 2);
                    log(gamesJson);
                    
                    log('\n‚úÖ Data fetch complete! Copy the JSON above to your files.', 'success');
                } else {
                    log('‚ùå No games were fetched. Check your API key and try again.', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
